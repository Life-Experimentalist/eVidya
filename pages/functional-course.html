<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>eVidya - Course Content</title>
		<!-- Bootstrap CSS -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<!-- Font Awesome -->
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
		/>
		<!-- Google Fonts -->
		<link
			href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link rel="stylesheet" href="../css/style.css" />
		<link rel="stylesheet" href="../css/course-details.css" />
		<link rel="stylesheet" href="../css/placeholder-images.css" />
		<style>
			body {
				font-family: "Poppins", sans-serif;
				background-color: #f9fafb;
			}

			header {
				background: linear-gradient(
					135deg,
					var(--primary-color),
					#0d47a1
				);
				padding: 3rem 0;
				margin-bottom: 0;
			}

			.loading {
				display: flex;
				justify-content: center;
				align-items: center;
				min-height: 200px;
				font-size: 1.1rem;
				color: var(--text-light);
			}

			.loading:after {
				content: "...";
				animation: dots 1.5s steps(5, end) infinite;
			}

			@keyframes dots {
				0%,
				20% {
					content: ".";
				}
				40% {
					content: "..";
				}
				60%,
				100% {
					content: "...";
				}
			}

			.btn {
				border-radius: 50px;
				padding: 0.6rem 1.5rem;
				font-weight: 500;
				letter-spacing: 0.5px;
				transition: all 0.3s ease;
			}

			.course-container {
				background: white;
				border-radius: 12px;
				overflow: hidden;
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
			}
		</style>
	</head>
	<body>
		<header>
			<div class="container">
				<h1 id="course-title" class="mb-2">Course Title</h1>
				<p class="lead" id="course-description">
					<i class="fas fa-circle-notch fa-spin me-2"></i>Loading
					course information...
				</p>
			</div>
		</header>

		<main class="container py-5">
			<div class="course-navigation mb-4">
				<a href="./courses.html" class="btn secondary-btn">
					<i class="fas fa-arrow-left me-2"></i>Back to Courses
				</a>
				<button id="reset-progress-btn" class="btn secondary-btn ms-2">
					<i class="fas fa-redo-alt me-2"></i>Reset Progress
				</button>
			</div>

			<div class="course-overview mb-4">
				<div class="progress-container mb-4">
					<h4><i class="fas fa-chart-line me-2"></i>Your progress</h4>
					<div class="progress mb-2">
						<div
							class="progress-bar"
							role="progressbar"
							id="progress-bar"
							style="width: 0%"
							aria-valuenow="0"
							aria-valuemin="0"
							aria-valuemax="100"
						>
							0%
						</div>
					</div>
					<p class="progress-text" id="progress-details">
						<i class="fas fa-spinner fa-pulse me-2"></i>Loading
						progress...
					</p>
				</div>
			</div>

			<div id="course-content">
				<div class="loading">Loading course content</div>
			</div>
		</main>

		<footer>
			<div class="container">
				<p>&copy; 2025 VKrishna04 Tech Courses. All rights reserved.</p>
			</div>
		</footer>

		<!-- Templates -->
		<template id="quiz-template">
			<div class="quiz-container">
				<h3 class="quiz-title mb-4">
					<i class="fas fa-question-circle me-2"></i
					><span class="quiz-title-text"></span>
				</h3>
				<form id="quiz-form">
					<div class="quiz-questions"></div>
					<button type="submit" class="btn primary-btn mt-4">
						<i class="fas fa-check-circle me-2"></i>Submit Answers
					</button>
				</form>
				<div id="quiz-results" class="mt-4 d-none">
					<div class="alert" role="alert"></div>
					<button id="retake-quiz" class="btn secondary-btn">
						<i class="fas fa-redo me-2"></i>Retake Quiz
					</button>
				</div>
			</div>
		</template>

		<template id="video-template">
			<div class="video-container">
				<h3 class="video-title mb-3">
					<i class="fas fa-play-circle me-2"></i
					><span class="video-title-text"></span>
				</h3>
				<div class="video-wrapper">
					<div id="youtube-player" class="ratio ratio-16x9">
						<div id="player"></div>
					</div>
				</div>
				<div class="video-description mt-3">
					<p class="description-text"></p>
					<div class="video-duration">
						<span class="badge bg-secondary"></span>
					</div>
				</div>
			</div>
		</template>

		<template id="section-template">
			<div class="section-container mb-5">
				<h2 class="section-title mb-4">
					<i class="fas fa-book me-2"></i
					><span class="section-title-text"></span>
				</h2>
				<div class="section-content">
					<div class="section-videos list-group mb-4"></div>
					<div class="section-quiz"></div>
				</div>
			</div>
		</template>

		<!-- Bootstrap JS Bundle with Popper -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<!-- YouTube API -->
		<script src="https://www.youtube.com/iframe_api"></script>
		<!-- App JS -->
		<script src="../js/main.js"></script>
		<script src="../js/storage.js"></script>
		<script src="../js/course-data.js"></script>
		<script src="../js/progress-tracker.js"></script>
		<script>
			document.addEventListener("DOMContentLoaded", function () {
				// Get courseId from URL parameters or localStorage
				let courseId = null;

				// First check URL parameters
				const urlParams = new URLSearchParams(window.location.search);
				if (urlParams.has("courseId")) {
					courseId = urlParams.get("courseId");
					// Save to localStorage for persistence
					localStorage.setItem("selectedCourseId", courseId);
				} else {
					// Try to get from localStorage as fallback
					courseId = localStorage.getItem("selectedCourseId");
				}

				// If still no courseId, default to first course
				if (
					!courseId &&
					window.courseData &&
					window.courseData.courses.length > 0
				) {
					courseId = window.courseData.courses[0].id;
					localStorage.setItem("selectedCourseId", courseId);
				}

				// Get the course data
				const course = window.courseData.getCourseById(courseId);

				if (!course) {
					document.getElementById("course-content").innerHTML = `
						<div class="alert alert-danger">
							<i class="fas fa-exclamation-circle me-2"></i>Course not found. Please <a href="./courses.html">go back</a> and select a course.
						</div>
					`;
					return;
				}

				// Update page title and header
				document.title = course.title + " - Tech Courses";
				document.getElementById("course-title").textContent =
					course.title;
				document.getElementById("course-description").textContent =
					course.description;

				// Initialize progress tracking
				const progress =
					window.ProgressTracker.getCourseProgress(courseId);
				updateProgressDisplay(progress);

				// Populate course content
				populateCourseContent(course);

				// Setup reset progress button
				document
					.getElementById("reset-progress-btn")
					.addEventListener("click", function () {
						if (
							confirm(
								"Are you sure you want to reset your progress for this course?"
							)
						) {
							window.ProgressTracker.resetCourseProgress(
								courseId
							);
							window.location.reload();
						}
					});
			});

			function updateProgressDisplay(progress) {
				const progressBar = document.getElementById("progress-bar");
				progressBar.style.width = progress.percentage + "%";
				progressBar.textContent = progress.percentage + "%";
				progressBar.setAttribute("aria-valuenow", progress.percentage);

				document.getElementById("progress-details").innerHTML =
					`<i class="fas fa-video me-2"></i>Videos: ${progress.completedVideos}/${progress.totalVideos} completed | ` +
					`<i class="fas fa-tasks me-2"></i>Quizzes: ${progress.completedQuizzes}/${progress.totalQuizzes} completed`;
			}

			function populateCourseContent(course) {
				const contentContainer =
					document.getElementById("course-content");
				contentContainer.innerHTML = "";

				// Check if there are sections to render
				if (!course.sections || course.sections.length === 0) {
					contentContainer.innerHTML = `
						<div class="alert alert-info">
							<i class="fas fa-info-circle me-2"></i>This course has no content yet. Please check back later.
						</div>
					`;
					return;
				}

				// Create sections from the course data
				course.sections.forEach((section) => {
					const sectionElement = document.createElement("div");
					sectionElement.className = "section-container mb-5";

					// Add section title
					const titleElement = document.createElement("h2");
					titleElement.className = "section-title mb-4";
					titleElement.innerHTML = `<i class="fas fa-book me-2"></i>${section.title}`;
					sectionElement.appendChild(titleElement);

					// Container for all section content
					const contentElement = document.createElement("div");
					contentElement.className = "section-content";

					// Add videos if available
					if (section.videos && section.videos.length > 0) {
						const videosContainer = document.createElement("div");
						videosContainer.className =
							"section-videos list-group mb-4";

						section.videos.forEach((video) => {
							// Check if video is completed
							const isCompleted =
								window.ProgressTracker.isVideoCompleted(
									course.id,
									video.id
								);

							// Create video item
							const videoItem = document.createElement("a");
							videoItem.href = "#";
							videoItem.className =
								"list-group-item list-group-item-action d-flex justify-content-between align-items-center";
							videoItem.innerHTML = `
								<span>
									<i class="fas fa-play-circle me-2 text-primary"></i>${video.title}
									${
										isCompleted
											? '<span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Completed</span>'
											: ""
									}
								</span>
								<span class="badge bg-secondary"><i class="far fa-clock me-1"></i>${
									video.duration
								}</span>
							`;

							// Add click event to load video
							videoItem.addEventListener("click", function (e) {
								e.preventDefault();
								loadVideo(course.id, video);
							});

							videosContainer.appendChild(videoItem);
						});

						contentElement.appendChild(videosContainer);
					}

					// Add quiz if available
					if (section.quiz) {
						const quizContainer = document.createElement("div");
						quizContainer.className = "section-quiz";

						const quizScore = window.ProgressTracker.getQuizScore(
							course.id,
							section.quiz.id
						);
						const isCompleted = quizScore !== null;

						const quizItem = document.createElement("a");
						quizItem.href = "#";
						quizItem.className =
							"list-group-item list-group-item-action d-flex justify-content-between align-items-center";
						quizItem.innerHTML = `
							<span>
								<i class="fas fa-question-circle me-2 text-primary"></i>${section.quiz.title}
								${
									isCompleted
										? `<span class="badge bg-success ms-2"><i class="fas fa-award me-1"></i>Score: ${quizScore}%</span>`
										: ""
								}
							</span>
							<span class="badge bg-primary"><i class="fas fa-tasks me-1"></i>Quiz</span>
						`;

						// Add click event to load quiz
						quizItem.addEventListener("click", function (e) {
							e.preventDefault();
							loadQuiz(course.id, section.quiz);
						});

						quizContainer.appendChild(quizItem);
						contentElement.appendChild(quizContainer);
					}

					sectionElement.appendChild(contentElement);
					contentContainer.appendChild(sectionElement);
				});
			}

			function loadVideo(courseId, video) {
				// Create modal to display video
				const modal = document.createElement("div");
				modal.className = "modal fade";
				modal.id = "videoModal";
				modal.setAttribute("tabindex", "-1");
				modal.setAttribute("aria-labelledby", "videoModalLabel");
				modal.setAttribute("aria-hidden", "true");

				modal.innerHTML = `
					<div class="modal-dialog modal-lg">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="videoModalLabel"><i class="fas fa-play-circle me-2"></i>${video.title}</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<div class="ratio ratio-16x9">
									<iframe id="youtube-video"
										src="https://www.youtube.com/embed/${video.videoId}?enablejsapi=1"
										title="YouTube video player"
										allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
										allowfullscreen>
									</iframe>
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-success" id="mark-complete-btn">
                                    <i class="fas fa-check-circle me-2"></i>Mark as Complete
                                </button>
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Close
                                </button>
							</div>
						</div>
					</div>
				`;

				document.body.appendChild(modal);

				// Initialize Bootstrap modal
				const modalInstance = new bootstrap.Modal(modal);
				modalInstance.show();

				// Handle marking video as complete
				document
					.getElementById("mark-complete-btn")
					.addEventListener("click", function () {
						window.ProgressTracker.markVideoComplete(
							courseId,
							video.id
						);
						modalInstance.hide();

						// Update progress display
						const progress =
							window.ProgressTracker.getCourseProgress(courseId);
						updateProgressDisplay(progress);

						// Refresh content to show completed label
						const course =
							window.courseData.getCourseById(courseId);
						populateCourseContent(course);
					});

				// Clean up when modal is hidden
				modal.addEventListener("hidden.bs.modal", function () {
					document.body.removeChild(modal);
				});
			}

			function loadQuiz(courseId, quiz) {
				// Create div to hold quiz content
				const quizContainer = document.createElement("div");
				quizContainer.className =
					"quiz-container mt-4 p-4 bg-light rounded";
				quizContainer.innerHTML = `
					<h3><i class="fas fa-question-circle me-2"></i>${quiz.title}</h3>
					<form id="quiz-form" class="mt-3">
						<!-- Questions will be inserted here -->
						<div class="quiz-questions"></div>
						<button type="submit" class="btn primary-btn mt-4">
                            <i class="fas fa-paper-plane me-2"></i>Submit Answers
                        </button>
					</form>
					<div id="quiz-results" class="mt-4 d-none">
						<div class="alert" role="alert"></div>
						<button id="retake-quiz" class="btn secondary-btn">
                            <i class="fas fa-redo me-2"></i>Retake Quiz
                        </button>
					</div>
				`;

				// Insert quiz into the page
				const contentDiv = document.getElementById("course-content");

				// Save original content to restore later
				const originalContent = contentDiv.innerHTML;
				contentDiv.innerHTML = "";
				contentDiv.appendChild(quizContainer);

				// Add a back button
				const backButton = document.createElement("button");
				backButton.className = "btn secondary-btn mt-3";
				backButton.innerHTML = `<i class="fas fa-arrow-left me-2"></i>Back to Course Content`;
				backButton.addEventListener("click", function () {
					contentDiv.innerHTML = originalContent;
				});
				contentDiv.appendChild(backButton);

				// Populate quiz questions
				const questionsContainer =
					document.querySelector(".quiz-questions");

				if (quiz.questions && quiz.questions.length > 0) {
					quiz.questions.forEach((question, index) => {
						const questionDiv = document.createElement("div");
						questionDiv.className = "mb-4";

						// Question text
						const questionText = document.createElement("p");
						questionText.className = "fw-bold mb-2";
						questionText.textContent = `${index + 1}. ${
							question.question
						}`;
						questionDiv.appendChild(questionText);

						// Options
						question.options.forEach((option, optIndex) => {
							const optionDiv = document.createElement("div");
							optionDiv.className = "form-check";

							const input = document.createElement("input");
							input.className = "form-check-input";
							input.type = "radio";
							input.name = `question-${index}`;
							input.id = `q${index}-option${optIndex}`;
							input.value = optIndex;

							const label = document.createElement("label");
							label.className = "form-check-label";
							label.htmlFor = `q${index}-option${optIndex}`;
							label.textContent = option;

							optionDiv.appendChild(input);
							optionDiv.appendChild(label);
							questionDiv.appendChild(optionDiv);
						});

						questionsContainer.appendChild(questionDiv);
					});

					// Handle form submission
					document
						.getElementById("quiz-form")
						.addEventListener("submit", function (e) {
							e.preventDefault();

							let correctAnswers = 0;

							// Check each answer
							quiz.questions.forEach((question, index) => {
								const selectedOption = document.querySelector(
									`input[name="question-${index}"]:checked`
								);

								if (
									selectedOption &&
									parseInt(selectedOption.value) ===
										question.correctAnswer
								) {
									correctAnswers++;
								}
							});

							// Calculate score
							const totalQuestions = quiz.questions.length;
							const score = Math.round(
								(correctAnswers / totalQuestions) * 100
							);

							// Save score
							window.ProgressTracker.saveQuizScore(
								courseId,
								quiz.id,
								score
							);

							// Display results
							const resultsDiv =
								document.getElementById("quiz-results");
							resultsDiv.classList.remove("d-none");

							const alertDiv = resultsDiv.querySelector(".alert");
							alertDiv.className =
								score >= 70
									? "alert alert-success"
									: "alert alert-warning";
							alertDiv.innerHTML = `
							<h4>${score >= 70 ? "Congratulations!" : "Nice try!"}</h4>
							<p>You scored ${score}% (${correctAnswers} out of ${totalQuestions} correct)</p>
							${
								score >= 70
									? "<p>You've passed this quiz!</p>"
									: "<p>Keep learning and try again.</p>"
							}
						`;

							// Hide the form
							document
								.getElementById("quiz-form")
								.classList.add("d-none");

							// Update progress display
							const progress =
								window.ProgressTracker.getCourseProgress(
									courseId
								);
							updateProgressDisplay(progress);
						});

					// Handle retaking the quiz
					document
						.getElementById("retake-quiz")
						.addEventListener("click", function () {
							document
								.getElementById("quiz-form")
								.classList.remove("d-none");
							document
								.getElementById("quiz-results")
								.classList.add("d-none");
							document.getElementById("quiz-form").reset();
						});
				} else {
					questionsContainer.innerHTML = `
						<div class="alert alert-warning">
							<i class="fas fa-exclamation-circle me-2"></i>No questions available for this quiz yet.
						</div>
					`;
				}
			}
		</script>
	</body>
</html>
