<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Course Catalogue - eVidya</title>
		<!-- Bootstrap CSS -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<!-- Font Awesome -->
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
		/>
		<!-- Google Fonts -->
		<link
			href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link rel="stylesheet" href="../css/style.css" />
		<link rel="stylesheet" href="../css/catalogue.css" />
		<!-- Add Material Icons for better UI elements -->
		<link
			href="https://fonts.googleapis.com/icon?family=Material+Icons"
			rel="stylesheet"
		/>
		<style>
			body {
				font-family: "Poppins", sans-serif;
				background-color: #f9fafb;
			}

			header {
				background: linear-gradient(
					135deg,
					var(--primary-color),
					#0d47a1
				);
				padding: 3rem 0;
				margin-bottom: 0;
			}
		</style>
	</head>
	<body>
		<header>
			<nav class="navbar navbar-expand-lg navbar-dark">
				<div class="container">
					<a class="navbar-brand" href="../index.html">
						<h2>eVidya Learning</h2>
					</a>
					<button
						class="navbar-toggler"
						type="button"
						data-bs-toggle="collapse"
						data-bs-target="#navbarMain"
						aria-controls="navbarMain"
						aria-expanded="false"
						aria-label="Toggle navigation"
					>
						<span class="navbar-toggler-icon"></span>
					</button>
					<div class="collapse navbar-collapse" id="navbarMain">
						<ul class="navbar-nav ms-auto mb-2 mb-lg-0">
							<li class="nav-item">
								<a class="nav-link" href="../index.html">
									<i class="fas fa-home me-1"></i> Home
								</a>
							</li>
							<li class="nav-item">
								<a
									class="nav-link active"
									href="./catalogue.html"
								>
									<i class="fas fa-book me-1"></i> Courses
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="./profile.html">
									<i class="fas fa-user me-1"></i> Profile
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="./settings.html">
									<i class="fas fa-cog me-1"></i> Settings
								</a>
							</li>
						</ul>
					</div>
				</div>
			</nav>

			<div class="container mt-4">
				<h1 class="text-center text-white mb-2">Course Catalogue</h1>
				<p class="lead text-center text-white">
					Explore our wide range of courses and start learning today
				</p>
			</div>
		</header>

		<main class="container py-5">
			<div class="catalogue-container">
				<!-- Currently Learning Section -->
				<div
					id="currently-learning-section"
					class="currently-learning-section"
				>
					<h2>Currently Learning</h2>
					<div id="currently-learning-container" class="courses-grid">
						<!-- Courses in progress will be displayed here -->
					</div>
					<div id="no-progress-message" style="display: none">
						You are not currently learning any courses. Start one
						today!
					</div>
				</div>

				<div class="filters-section">
					<h2>Filters</h2>
					<div class="filter-group">
						<h3>Subject</h3>
						<div class="filter-options" id="subject-filters">
							<!-- Subject filters will be dynamically generated -->
						</div>
					</div>
					<div class="filter-group">
						<h3>Difficulty</h3>
						<div class="filter-options">
							<label
								><input
									type="checkbox"
									value="Beginner"
									class="difficulty-filter"
								/>
								Beginner</label
							>
							<label
								><input
									type="checkbox"
									value="Intermediate"
									class="difficulty-filter"
								/>
								Intermediate</label
							>
							<label
								><input
									type="checkbox"
									value="Advanced"
									class="difficulty-filter"
								/>
								Advanced</label
							>
						</div>
					</div>
					<button id="reset-filters" class="btn secondary-btn">
						Reset Filters
					</button>
				</div>

				<div class="courses-section">
					<div class="search-controls">
						<div class="search-bar">
							<input
								type="text"
								id="search-input"
								placeholder="Search courses..."
							/>
							<button id="search-button" class="btn primary-btn">
								Search
							</button>
						</div>
						<div class="view-options">
							<button id="grid-view" class="view-btn active">
								<span class="material-icons">grid_view</span>
							</button>
							<button id="list-view" class="view-btn">
								<span class="material-icons">view_list</span>
							</button>
						</div>
					</div>

					<div id="courses-container" class="courses-grid">
						<!-- Courses will be displayed here -->
					</div>
					<div id="loading-indicator" style="display: none">
						Loading courses...
					</div>
					<div id="no-courses-message" style="display: none">
						No courses found matching your criteria.
					</div>
				</div>
			</div>
		</main>

		<footer>
			<div class="container">
				<p>
					&copy; 2025 VKrishna04 eVidya Tech Courses. All rights
					reserved.
				</p>
			</div>
		</footer>

		<!-- Bootstrap JS Bundle with Popper -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<!-- Load config first to access API keys -->
		<script src="../js/config.js"></script>
		<!-- Load the course data -->
		<script src="../data/course-data.js"></script>
		<script>
			// DOM elements
			const coursesContainer =
				document.getElementById("courses-container");
			const currentlyLearningContainer = document.getElementById(
				"currently-learning-container"
			);
			const noProgressMessage = document.getElementById(
				"no-progress-message"
			);
			const loadingIndicator =
				document.getElementById("loading-indicator");
			const noCoursesMessage =
				document.getElementById("no-courses-message");
			const searchInput = document.getElementById("search-input");
			const searchButton = document.getElementById("search-button");
			const resetFiltersButton = document.getElementById("reset-filters");
			const gridViewButton = document.getElementById("grid-view");
			const listViewButton = document.getElementById("list-view");
			const difficultyFilters =
				document.querySelectorAll(".difficulty-filter");
			const subjectFiltersContainer =
				document.getElementById("subject-filters");

			// Keep track of current filters
			let currentFilters = {
				subjects: [],
				difficulties: [],
				searchTerm: "",
			};

			// Course progress data (would be stored in localStorage in a real app)
			// Format: { courseId: progressPercentage }
			let courseProgress =
				JSON.parse(localStorage.getItem("courseProgress")) || {};

			// For demo purposes, set some initial progress if none exists
			if (Object.keys(courseProgress).length === 0) {
				// Set random progress for some courses
				if (window.courses && window.courses.length > 0) {
					courseProgress[window.courses[0].id] = 30; // First course at 30%
					if (window.courses.length > 2) {
						courseProgress[window.courses[2].id] = 75; // Third course at 75%
					}
					localStorage.setItem(
						"courseProgress",
						JSON.stringify(courseProgress)
					);
				}
			}

			 // Unsplash API key
			let unsplashAccessKey = '';

			// Try to load API key from environment
			try {
				// In browser environment, we need to load it from a server-side rendered variable
				// or from config that's properly set up for client-side
				unsplashAccessKey = config?.unsplash?.accessKey || '';

				// Fallback for development if not available
				if (!unsplashAccessKey || unsplashAccessKey === 'YOUR_DEVELOPMENT_KEY') {
					console.warn('Unsplash API key not found, using Picsum as fallback');
				}
			} catch (error) {
				console.error('Error loading config:', error);
			}

			// Show loading state
			function showLoading() {
				loadingIndicator.style.display = "block";
				coursesContainer.innerHTML = "";
				noCoursesMessage.style.display = "none";
			}

			// Function to create a course card
			function createCourseCard(course, showProgress = false) {
				const card = document.createElement("div");
				card.className = "course-card";

				const progress = courseProgress[course.id] || 0;

				// Set up the progress bar HTML if needed
				const progressHTML = showProgress ?
					`<div class="progress-bar-container">
						<div class="progress-bar" style="width: ${progress}%"></div>
					</div>
					<div class="progress-text">${progress}% Complete</div>` : '';

				// Get image URL using the config method instead of fetching from Unsplash
				const imagePath = config.images.getCourseImageUrl(course);

				// Create card HTML
				card.innerHTML = `
					<div class="course-image">
						<img src="${imagePath}" alt="${course.title}" onerror="this.src='https://picsum.photos/800/450?random=${course.id}'; this.onerror=null;">
						<div class="difficulty-badge ${course.level.toLowerCase()}">${course.level}</div>
					</div>
					<div class="course-content">
						<h3>${course.title}</h3>
						<p>${course.description}</p>
						<div class="course-meta">
							<span><i class="material-icons">schedule</i> ${course.duration}</span>
							<span><i class="material-icons">category</i> ${course.subject}</span>
						</div>
						${progressHTML}
						<a href="course-details.html?courseId=${course.id}" class="btn primary-btn btn-block">View Course</a>
					</div>
				`;

				return card;
			}

			// Display all courses
			function displayCourses(courses, container) {
				container.innerHTML = "";

				if (courses.length === 0) {
					if (container === coursesContainer) {
						noCoursesMessage.style.display = "block";
					} else if (container === currentlyLearningContainer) {
						noProgressMessage.style.display = "block";
					}
					return;
				}

				if (container === currentlyLearningContainer) {
					noProgressMessage.style.display = "none";
				} else {
					noCoursesMessage.style.display = "none";
				}

				courses.forEach((course) => {
					const showProgress =
						container === currentlyLearningContainer;
					const card = createCourseCard(course, showProgress);
					container.appendChild(card);
				});
			}

			// Filter courses based on current filters
			function filterCourses() {
				showLoading();

				const allCourses = window.courses || [];
				let filteredCourses = [...allCourses];

				// Apply subject filter
				if (currentFilters.subjects.length > 0) {
					filteredCourses = filteredCourses.filter((course) =>
						currentFilters.subjects.includes(course.subject)
					);
				}

				// Apply difficulty filter
				if (currentFilters.difficulties.length > 0) {
					filteredCourses = filteredCourses.filter((course) =>
						currentFilters.difficulties.includes(course.level)
					);
				}

				// Apply search filter
				if (currentFilters.searchTerm) {
					const searchTerm = currentFilters.searchTerm.toLowerCase();
					filteredCourses = filteredCourses.filter(
						(course) =>
							course.title.toLowerCase().includes(searchTerm) ||
							course.description
								.toLowerCase()
								.includes(searchTerm) ||
							course.subject.toLowerCase().includes(searchTerm) ||
							(course.subSection &&
								course.subSection
									.toLowerCase()
									.includes(searchTerm))
					);
				}

				// Find courses with progress
				const inProgressCourses = allCourses.filter(
					(course) =>
						courseProgress[course.id] &&
						courseProgress[course.id] > 0
				);

				// Sort by progress (highest first)
				inProgressCourses.sort(
					(a, b) => courseProgress[b.id] - courseProgress[a.id]
				);

				// Display in-progress courses
				displayCourses(inProgressCourses, currentlyLearningContainer);

				// Display filtered courses (with a small delay to simulate loading)
				setTimeout(() => {
					loadingIndicator.style.display = "none";
					displayCourses(filteredCourses, coursesContainer);
				}, 300);
			}

			// Generate subject filters dynamically
			function generateSubjectFilters() {
				if (!window.courses) return;

				// Get unique subjects
				const subjects = [
					...new Set(window.courses.map((course) => course.subject)),
				];

				// Create checkbox for each subject
				subjects.forEach((subject) => {
					const label = document.createElement("label");
					label.innerHTML = `<input type="checkbox" value="${subject}" class="subject-filter"> ${subject}`;
					subjectFiltersContainer.appendChild(label);
				});

				// Add event listeners to new checkboxes
				document
					.querySelectorAll(".subject-filter")
					.forEach((filter) => {
						filter.addEventListener("change", function () {
							if (this.checked) {
								currentFilters.subjects.push(this.value);
							} else {
								currentFilters.subjects =
									currentFilters.subjects.filter(
										(subject) => subject !== this.value
									);
							}
							filterCourses();
						});
					});
			}

			// Event listeners for difficulty filters
			difficultyFilters.forEach((filter) => {
				filter.addEventListener("change", function () {
					if (this.checked) {
						currentFilters.difficulties.push(this.value);
					} else {
						currentFilters.difficulties =
							currentFilters.difficulties.filter(
								(difficulty) => difficulty !== this.value
							);
					}
					filterCourses();
				});
			});

			// Event listener for search
			searchButton.addEventListener("click", function () {
				currentFilters.searchTerm = searchInput.value.trim();
				filterCourses();
			});

			// Event listener for search input (search on Enter key)
			searchInput.addEventListener("keyup", function (event) {
				if (event.key === "Enter") {
					currentFilters.searchTerm = searchInput.value.trim();
					filterCourses();
				}
			});

			// Event listener for reset filters
			resetFiltersButton.addEventListener("click", function () {
				// Uncheck all checkboxes
				document
					.querySelectorAll(".subject-filter, .difficulty-filter")
					.forEach((filter) => {
						filter.checked = false;
					});

				// Clear search input
				searchInput.value = "";

				// Reset filters object
				currentFilters = {
					subjects: [],
					difficulties: [],
					searchTerm: "",
				};

				// Apply filters (show all courses)
				filterCourses();
			});

			// Event listeners for view toggles
			gridViewButton.addEventListener("click", function () {
				coursesContainer.className = "courses-grid";
				currentlyLearningContainer.className = "courses-grid";
				gridViewButton.classList.add("active");
				listViewButton.classList.remove("active");
			});

			listViewButton.addEventListener("click", function () {
				coursesContainer.className = "courses-list";
				currentlyLearningContainer.className = "courses-list";
				listViewButton.classList.add("active");
				gridViewButton.classList.remove("active");
			});

			// Initial loading of courses
			window.addEventListener("DOMContentLoaded", function () {
				if (window.courses) {
					generateSubjectFilters();
					filterCourses();
				} else {
					console.error(
						"Course data not found. Make sure course-data.js is properly loaded."
					);
					noCoursesMessage.textContent =
						"Failed to load course data.";
					noCoursesMessage.style.display = "block";
				}
			});
		</script>
	</body>
</html>
